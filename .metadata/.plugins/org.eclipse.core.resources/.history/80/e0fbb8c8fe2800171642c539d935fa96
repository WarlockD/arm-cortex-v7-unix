/*
 * nuttxinode.h
 *
 *  Created on: Apr 24, 2017
 *      Author: warlo
 */

#ifndef XV6CPP_NUTTXINODE_H_
#define XV6CPP_NUTTXINODE_H_

#include "os.h"
#include "list.h"
#include "bitmap.h"
namespace nuttx {

	class nuttx_inode {
	public:
		/* Inode i_flag values */
		enum class type {
			deleted=0, /* Unlinked     */
			driver, /*   Character driver         */
			block, /*   Block driver             */
			mountpt, /*   Character driver         */
			special, /* Special OS type            */
			nsemaphore, /*   Named semaphore          */
			mqueue, /*   Character driver         */
			smr, /*   Shared memory region     */
		};

		nuttx_inode(const char* name, type t=type::special) :  _crefs(1), _flags(t), _mode(0), _name(name),  _child{nullptr} {}
		void release(); // releases this inode
		~nuttx_inode() { assert(_crefs==0); }
		inline const char* name() const { return _name; }
		inline type flags() const { return _flags; }
		inline mode_t mode() const { return _mode; }
		nuttx_inode *search(const char **path,nuttx_inode **peer,nuttx_inode **parent,const char **relpath);
		nuttx_inode *find(const char *path, const char **relpath);
		static nuttx_inode *root_search(const char **path,nuttx_inode **peer,nuttx_inode **parent,const char **relpath);
		static nuttx_inode *root_find(const char *path, const char **relpath);

		void unlink();
		void addref() { bitops::atomic_add(1,&_crefs); }
		void* operator new(size_t size);
		void operator delete(void *ptr);
	protected:
		static void ifree(nuttx_inode* n); // releases the node, back to the pool
		static nuttx_inode* ialloc(const char* name, type t=type::special); // releases the node, back to the pool
		int16_t			_crefs;    /* References to inode */
		type			_flags;    /* Flags for inode */
		mode_t			_mode;	 /* Access mode flags */
		const char* 	_name;/* Name of inode (variable) */
		LIST_CLASS_HEAD(,nuttx_inode) _child;    /* Link to lower level inode */
		LIST_CLASS_ENTRY(nuttx_inode) _peer; /* Link to same level inode */

	};

} /* namespace xv6 */

#endif /* XV6CPP_NUTTXINODE_H_ */
