/*
 * nuttxinode.h
 *
 *  Created on: Apr 24, 2017
 *      Author: warlo
 */

#ifndef XV6CPP_NUTTXINODE_H_
#define XV6CPP_NUTTXINODE_H_

#include "os.h"
#include "list.h"
#include "bitmap.h"
namespace nuttx {

	class nuttx_inode {
	public:
		constexpr static inline bool dir_sep(char c) { return c == '\\' || c == '/'; }
		constexpr static inline bool dir_end(char c) { return dir_sep(c) || c == '\0'; }
		static int dir_compare(const char *fname, const char *nname);
		static const char *dir_basename(const char *name);
		static const char *dir_nextname(const char *name);
		/* Inode i_flag values */
		enum class type {
			deleted=0, /* Unlinked     */
			driver, /*   Character driver         */
			block, /*   Block driver             */
			mountpt, /*   Character driver         */
			special, /* Special OS type            */
			nsemaphore, /*   Named semaphore          */
			mqueue, /*   Character driver         */
			smr, /*   Shared memory region     */
		};
		class iterator {
			nuttx_inode* _node;
		public:
			iterator(nuttx_inode* node) : _node(node) {}
			bool operator==(const iterator& l) const { return _node == l._node; }
			bool operator!=(const iterator& l) const { return _node == l._node; }
			iterator operator++() {
				if(_node) _node = LIST_NEXT(_node,_peer);
				return iterator(_node);
			}
			iterator operator++(int){
				iterator t(_node);
				if(_node) _node = LIST_NEXT(_node,_peer);
				return t;
			}
			nuttx_inode* operator->() const { return _node; }
			operator nuttx_inode*() { return _node;}
		};
		nuttx_inode(const char* name, type t=type::special);
		iterator begin() { return iterator(LIST_FIRST(&_child)); }
		iterator end() { return iterator(nullptr); }

		void release(); // releases this inode
		~nuttx_inode();
		inline const char* name() const { return _name; }
		inline type flags() const { return _flags; }
		inline mode_t mode() const { return _mode; }
		nuttx_inode *find(const char *path, const char **relpath=nullptr,nuttx_inode** parent=nullptr);
		static nuttx_inode *root_find(const char *path, const char **relpath);
		nuttx_inode * link(const char* name, type t=type::special);
		void link(nuttx_inode* n);
		nuttx_inode * unlink(const char* path);
		void unlink();
		void addref() { bitops::atomic_add(1,&_crefs); }
		void* operator new(size_t size);
		void operator delete(void *ptr);
	protected:
		static void ifree(nuttx_inode* n); // releases the node, back to the pool
		int16_t			_crefs;    /* References to inode */
		type			_flags;    /* Flags for inode */
		mode_t			_mode;	 /* Access mode flags */
		char			_name[32];/* Name of inode (variable) */
		LIST_CLASS_HEAD(,nuttx_inode) _child;    /* Link to lower level inode */
		LIST_CLASS_ENTRY(nuttx_inode) _peer; /* Link to same level inode */

	};

} /* namespace xv6 */

#endif /* XV6CPP_NUTTXINODE_H_ */
